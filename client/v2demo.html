<!DOCTYPE html>
<html>
<head>
    <title>rolling ball demo</title>
    <script src="js/external/p5.min.js"></script>
    
    <style>
    html,body {
        margin:0;
        padding:0;
        width:100%;
        height:100%;
        overflow: hidden;
    }
    </style>

    <meta name="description" content="Ihtai 2 demo">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
<script type="text/javascript">
function setup() {

  // Sets the screen to be 720 pixels wide and 400 pixels high
  createCanvas(720, 400);
  background(0);
  noStroke();

  fill(204);
  triangle(18, 18, 18, 360, 81, 360);

  fill(102);
  rect(81, 81, 63, 63);

  fill(204);
  quad(189, 18, 216, 18, 216, 360, 144, 360);

  fill(255);
  ellipse(252, 144, 72, 72);

  fill(204);
  triangle(288, 18, 351, 360, 288, 360); 

  fill(255);
  arc(479, 300, 280, 280, PI, TWO_PI);
}

var secretNumber = 4;
var startingData = JSON.stringify({
    startingData: [
      { inputState:[0], actionState: [0], driveState: [0] },
      { inputState: [1], actionState: [1], driveState: [1] },
      { inputState:[2], actionState: [2], driveState: [2] },
      { inputState: [3], actionState: [3], driveState: [3] }          
    ],
    possibleDataValues: [
      [0, 1, 2, 3, 4, 5, 6], 
      [0, 1, 2, 3, 4, 5, 6],
      [0, 1, 2, 3, 4, 5, 6]
    ]
});

// WARNING: WIPES OUT ALL SAVED IHTAI DATA
function clearDb() {
    return fetch('http://localhost:3800/db', {
        method: 'delete'
    });
};

// clearDb();

//////// START DATA FETCH CHAIN ////////
fetch('http://localhost:3800/initialize', {
    method: 'post',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: startingData
}).then(function(response) {
    getNearestPatternRecognizer(); 
}).catch(function(err) {

});

function getNearestPatternRecognizer() {
    var data = JSON.stringify({
        inputState: [5],
        actionState: [5],
        driveState: [5]
    });

    return fetch('http://localhost:3800/nearestPatternRecognizer', {
        method: 'post',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: data
    }).then((result) => {
        addTimeStep(result);
    });
}

function addTimeStep(nearestPatternRecognizer) {
    // stateKey must match an existing pattern
    var data = JSON.stringify({
        stateKey: '3_3_3',
        score: 5
    });

    return fetch('http://localhost:3800/addTimeStep', {
        method: 'put',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: data
    }).then(() => {
        updateScore();
    });
}

function updateScore() {
    return fetch('http://localhost:3800/updateScore', {
        method: 'get'
    }).then(() => {
        // todo: use real pattern
        getBestNextAction('pattern_3_3_3');
    }).catch((message) => {
        // for this api call it's probably ok to ignore error
        // because this will return 500 if not enough items are in the stack to calculate. could check for message or start including status codes
        getBestNextAction('pattern_3_3_3');
    });
}

function getBestNextAction(patternString) {
    var data = JSON.stringify({
        patternString: patternString
    });

    return fetch('http://localhost:3800/bestNextAction', {
        method: 'post',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: data
    }).then(() => {
        getUpdatesPerMinute(patternString);
    });
}

// get updates per minute for a given patternRecognizer
function getUpdatesPerMinute(patternString) {
    var data = JSON.stringify({
        patternString: patternString
    });

    return fetch('http://localhost:3800/updatesPerMinute', {
        method: 'post',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: data
    }).then((res) => {
        // TODO: if res > arbitrary number, call splitPatternRecognizer
        // passing patternString and the new point based on current client state
        // if (...) { splitPatternRecognizer(patternString, {...}) }

        // repeat logic loop, calling getNearestPatternRecognizer
        // getNearestPatternRecognizer();
    });    
}

// make this method only run if pattern access velocity > than arbitrary cutoff
function splitPatternRecognizer(originalPatternRecognizerString, newPoint) {
    var data = JSON.stringify({
        originalPatternRecognizerString: originalPatternRecognizerString,
        newPoint: newPoint
    });

    return fetch('http://localhost:3800/splitPatternRecognizer', {
        method: 'post',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: data
    }).then(() => {
        
    });
}

</script>
</body>
</html>
